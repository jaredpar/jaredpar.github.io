<P>This is part 2 of a series.&nbsp; You can find <A href="http://blogs.msdn.com/jaredpar/archive/2005/07/11/437584.aspx" mce_href="http://blogs.msdn.com/jaredpar/archive/2005/07/11/437584.aspx">part one here</A>.&nbsp; Please refer to that article for all of the Native definitions of the structures that I use here.</P>
<P>The most important thing to remember when Marshalling data is that the .Net Runtime really only cares about byte layout and how many bytes you are trying to move.&nbsp; If you mangle your managed structure to match the byte size and layout&nbsp;of your unmanaged structure, the runtime will Marshal it sucessfully almost all of the time.&nbsp; Note by successfully I mean that the method will complete without causing the dreaded AccessViolationException but the data might not be quite what you were expecting.&nbsp; </P>
<P>For example.&nbsp; Here is the typical managed definition for the Student struct definition.&nbsp; </P>
<P mce_keep="true">&nbsp;</P><PRE>    [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]
    public struct Student
    {
        [MarshalAs(UnmanagedType.ByValTStr, SizeConst = 10)]
        public string FirstName;

        [MarshalAs(UnmanagedType.ByValTStr, SizeConst = 10)]
        public string LastName;

        public int BirthDay;
        public int BirthMonth;
        public int BirthYear;
    }
</PRE>
<P>Notice that the size of this structure is 52 bytes.&nbsp; </P>
<UL>
<LI>FirstName 2 (size of char) * 10 (size of array) 
<LI>LastName 2 (size of char) * 10 (size of array) 
<LI>12 bytes (4 bytes for each of the int's)</LI></UL>
<P>This is the same size as the native definiton of Student.&nbsp; In memory these bytes will all appear in order with no spaces between them (FirstName and LastName are set as ByValTStr's so they will be inlined).&nbsp; So LastName is 20 bytes offset of a student structure, BirthDay is 40 bytes offset and so on.&nbsp; </P>
<P>You don't always have to be so perfect though.&nbsp; In this case it's only important because we want to accesss the fields of the managed structure.&nbsp; If this was not important to us, we could have just as easily declared the structure as so.&nbsp; </P>
<P mce_keep="true">&nbsp;</P><PRE>    [StructLayout(LayoutKind.Sequential, Size = 52, CharSet = CharSet.Unicode)]
    public struct Student
    { 

    }
</PRE>
<P>Note that i didn't leave anything out in the structure above.&nbsp; It has the correct CharSet and Size so this could be successfully used wherever we need the Student structure.&nbsp; It just doesn't help us very much in Managed code :) </P>
<P>Now onto the Course.&nbsp; A lot of developers get tripped up when trying to define structs like Course in managed code.&nbsp; Don't forget, all we need to do is get the bytes correct and the Marshaller will work out the rest.&nbsp;</P>
<P>This structure is very small.&nbsp; There are only 5 inlined elements in the student array.&nbsp; This means that we could easily define our structure as so.&nbsp; </P>
<P mce_keep="true">&nbsp;</P><PRE>    [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]
    public struct Course
    {
        public int Id;
        public int Count;
        Student Student0;
        Student Student1;
        Student Student2;
        Student Student3;
        Student Student4;
    }
</PRE>
<P>I realize there are several downsides to defining our structure like this.&nbsp; For one, it doesn't look very clean.&nbsp; Secondly we've lost the ability to easily index the array of students.&nbsp; Also this works easily because there are only 5 elements in the array.&nbsp; If there were much more than that this wouldn't be pheasible at all.&nbsp; However this structure is layed out exactly like the one defined in Native code so this will Marshal correctly.&nbsp; </P>
<P>The next part to this series will try to make things a bit more pleasing to the eye. We'll get back indexing at the cost of&nbsp;a bit of manual Marshalling.&nbsp; </P>
<P><FONT size=2>This posting is provided "AS IS" with no warranties, and confers no rights. <BR>Use of included script samples are subject to the terms specified at </FONT><A title=http href="http://www.microsoft.com/info/cpyright.htm" mce_href="http://www.microsoft.com/info/cpyright.htm"><FONT face=Verdana color=#223355 size=2><STRONG>http://www.microsoft.com/info/cpyright.htm</STRONG></FONT></A><FONT face=Verdana size=2>.</FONT></P><div style="clear:both;"></div></div>
    
<P>ATL has a lot of great tools for COM programming and <A href="http://msdn2.microsoft.com/en-us/library/ezzw7k98(VS.80).aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ezzw7k98(VS.80).aspx">CComPtr</A> is a good example.&nbsp; It's a smart pointer class which manages the reference count of an underlying COM object. </P>
<P>One of it's limitations though is it will only work properly when the inheritance chain for a class has only one path to IUnknown.&nbsp; If it has more than one path, the following error will be issued when you attempt to assign a value of type T to the CComPtr.</P>
<P>error C2594: 'argument' : ambiguous conversions from 'SomeClass *' to 'IUnknown *'&nbsp;&nbsp;&nbsp; </P>
<P>The reason behind this is the operator= for CComPtr uses <A href="http://msdn2.microsoft.com/en-us/library/40d27a83(vs.71).aspx" mce_href="http://msdn2.microsoft.com/en-us/library/40d27a83(vs.71).aspx">AtlComPtrAssign</A> to change the references.&nbsp; The right hand side of the assignment is passed to this function as IUnknown.&nbsp; Since there are multiple paths to IUnknown the C++ compiler cannot implicitly perform the cast and issues the above error.&nbsp; </P>
<P>I most frequently encounter this error in larger code bases with older classes.&nbsp; New functionality is needed so I add a new interface and end up with a lot of C2594 errors.&nbsp; </P>
<P>To work around this I defined a new CComPtr class named CComPtrEx which inherits from CComPtr base.&nbsp; It defines the same operators as CComPtr but uses a Copy Constructor and Swap to perform the = which gets around the multiple paths to IUnknown.&nbsp; The rest of the functions are identical to CComPtr.&nbsp; </P><PRE class=code><SPAN style="COLOR: rgb(0,0,255)">template</SPAN> &lt;<SPAN style="COLOR: rgb(0,0,255)">class</SPAN> T&gt;
<SPAN style="COLOR: rgb(0,0,255)">class</SPAN> CComPtrEx : <SPAN style="COLOR: rgb(0,0,255)">public</SPAN> CComPtrBase&lt;T&gt;
{
<SPAN style="COLOR: rgb(0,0,255)">public</SPAN>:
    CComPtrEx() <SPAN style="COLOR: rgb(0,0,255)">throw</SPAN>()
    {
    }
    CComPtrEx(<SPAN style="COLOR: rgb(0,0,255)">int</SPAN> nNull) <SPAN style="COLOR: rgb(0,0,255)">throw</SPAN>() :
        CComPtrBase&lt;T&gt;(nNull)
    {
    }
    CComPtrEx(T* lp) <SPAN style="COLOR: rgb(0,0,255)">throw</SPAN>() :
        CComPtrBase&lt;T&gt;(lp)
    {
    }
    CComPtrEx(_In_ <SPAN style="COLOR: rgb(0,0,255)">const</SPAN> CComPtrEx&lt;T&gt;&amp; lp) <SPAN style="COLOR: rgb(0,0,255)">throw</SPAN>() :
        CComPtrBase&lt;T&gt;(lp.p)
    {
    }

    T* <SPAN style="COLOR: rgb(0,0,255)">operator</SPAN>=(_In_opt_ T* lp) <SPAN style="COLOR: rgb(0,0,255)">throw</SPAN>()
    {
        <SPAN style="COLOR: rgb(0,0,255)">if</SPAN>(*<SPAN style="COLOR: rgb(0,0,255)">this</SPAN>!=lp)
        {
            CComPtrEx&lt;T&gt; sp(lp);
            Swap(&amp;p, &amp;sp.p);
        }
        <SPAN style="COLOR: rgb(0,0,255)">return</SPAN> *<SPAN style="COLOR: rgb(0,0,255)">this</SPAN>;
    }

    T* <SPAN style="COLOR: rgb(0,0,255)">operator</SPAN>=(_In_ <SPAN style="COLOR: rgb(0,0,255)">const</SPAN> CComPtrEx&lt;T&gt;&amp; lp) <SPAN style="COLOR: rgb(0,0,255)">throw</SPAN>()
    {
        <SPAN style="COLOR: rgb(0,0,255)">if</SPAN>(*<SPAN style="COLOR: rgb(0,0,255)">this</SPAN>!=lp)
        {
            CComPtrEx&lt;T&gt; sp(lp);
            Swap(&amp;p, &amp;sp.p);
        }
        <SPAN style="COLOR: rgb(0,0,255)">return</SPAN> *<SPAN style="COLOR: rgb(0,0,255)">this</SPAN>;
    }
};</PRE><A href="http://11011.net/software/vspaste" mce_href="http://11011.net/software/vspaste"></A></div>
    
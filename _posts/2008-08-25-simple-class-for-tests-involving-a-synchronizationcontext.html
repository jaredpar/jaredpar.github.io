<p>Recently I had to test a class which heavily depended upon a <a href="http://msdn.microsoft.com/en-us/library/system.threading.synchronizationcontext.aspx">SynchronizationContext</a>.&#160; This threw me off for about half an hour as I didn't want to write multi-threaded unit tests.&#160; Multi-threaded code is difficult enough without adding needless threads.&#160; </p>  <p>The solution I came up with is simple and gives the unit test a large degree of control over the execution of posted delegates.&#160; The resulting tests were much easier to code and understand. </p>  <pre class="code"><span style="color: blue">public sealed class </span><span style="color: #2b91af">TestSynchronizationContext </span>: <span style="color: #2b91af">SynchronizationContext </span>{
    <span style="color: blue">private </span><span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">Tuple</span>&lt;<span style="color: #2b91af">SendOrPostCallback</span>, <span style="color: blue">object</span>&gt;&gt; m_pending 
        = <span style="color: blue">new </span><span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">Tuple</span>&lt;<span style="color: #2b91af">SendOrPostCallback</span>, <span style="color: blue">object</span>&gt;&gt;();

    <span style="color: blue">public override void </span>Send(<span style="color: #2b91af">SendOrPostCallback </span>d, <span style="color: blue">object </span>state) {
        d(state);
    }

    <span style="color: blue">public override void </span>Post(<span style="color: #2b91af">SendOrPostCallback </span>d, <span style="color: blue">object </span>state) {
        m_pending.Add(<span style="color: #2b91af">Tuple</span>.Create(d, state));
    }

    <span style="color: blue">public void </span>RunAllPosted() {
        m_pending.ForEach(x =&gt; x.First(x.Second));
    }
}</pre>
<a href="http://11011.net/software/vspaste"></a></div>
    
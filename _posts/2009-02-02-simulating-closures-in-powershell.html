<p><a href="http://blogs.msdn.com/jaredpar/archive/2009/01/08/script-blocks-and-closures-or-lack-there-of.aspx">Previously</a> I blogged about PowerShell’s lack of closure support within a script block.&#160; This presents a significant hurdle in developing a LINQ like DSL for powershell which I’ve been working on.&#160; Imagine the following syntax</p>  <pre>$a = from it in $source where {$it -gt 5 }</pre>

<p>This would be the rough equivalent of the following C# code</p>

<pre class="code"><span style="color: blue">var </span>a = <span style="color: blue">from </span>it <span style="color: blue">in </span>source <span style="color: blue">where </span>it &gt; 5;</pre>
<a href="http://11011.net/software/vspaste"></a>

<p>In C# this code works because the where clause “it &gt; 5” is converted to a lambda expression under the hood.&#160; The variable it is captured in the lambda expression via a closure.&#160; In order to get similar functionality out of powershell, the value $it must be resolvable when the “where” scriptblock is executed.</p>

<p>Luckily Powershell is incredibly flexible.&#160; When a script block executes it will attempt to resolve any variables by looking through the various scopes.&#160; The first scope is that of the script block, and then the local scope of the code in which the script block is executed.&#160; Using new-variable, we can create variables which match the name the script block is looking for and simulate a closure.&#160; </p>

<pre>PS) $sb = { write-host $it }
PS) &amp; $sb

PS) new-variable &quot;it&quot; 42 -scope local
PS) &amp; $sb
42</pre>

<p>Success!&#160; Now all we need to do is generalize this behavior by creating a function: Run-Scriptblock.&#160; It takes two arguments</p>

<ol>
  <li>The scriptblock to execute </li>

  <li>A list of name/value pairs.&#160; Each one represents a variable that must be available for the execution of the scriptblock </li>
</ol>

<p>Code:</p>

<pre>#============================================================================
# Runs a script block.  The $list parameter must be a list of string, value
# combinations.  The script block will be executed with variables of the 
# specified name and value in scope
#============================================================================
function Run-Scriptblock() {
    param ( [scriptblock] $sb = $(throw &quot;Need a script block&quot;), 
            [object[]]$list= $(throw &quot;Please specify the list of names and values&quot;) )

    for ( $i = 0; $i -lt $list.Length; $i = $i+2 ) {
        $name = [string]($list[$i])
        $value = $list[$i+1]
        new-variable -name $name -value $value -scope &quot;local&quot;
    }

    &amp; $sb
}</pre>

<p>Example Usage:</p>

<pre>PS) $sb = { write-host $it }
PS) run-scriptblock $sb &quot;it&quot;,42
42
PS) $it</pre>

<p>Now we have the method by which to execute a “where” clause.&#160; Next time we’ll look at actually defining a LINQ DSL in powershell.&#160; </p></div>
    
<p>I'm a bit busier than I thought I would be after returning from vacation.&#160; But I had a little bit of time to play around with the implementation again today.&#160; Thanks to all the suggestions in the comments from the <a href="http://blogs.msdn.com/jaredpar/archive/2008/08/15/immutablestack-in-f.aspx">previous post</a>.&#160; </p>  <p>This version has a couple of improvements including </p>  <ol>   <li>Removing the ambiguous constructor</li>    <li>More efficient All() implementation</li> </ol>  <p>Remaining issues:</p>  <ul>   <li>Need to make it generic :)</li>    <li>Still exposing a type union.&#160; Great for F# but it produces somewhat awkward looking metadata for non-F# languages to consume</li> </ul>  <p>#light </p>  <p>namespace Col   <br />&#160;&#160;&#160; type ImmutableStack =    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; | EmptyStack    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; | Value of int * ImmutableStack    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; static member Empty = EmptyStack    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; static member Create( l:#seq&lt;int&gt; ) =     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; let s = ref ImmutableStack.Empty    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; l |&gt; Seq.iter (fun n -&gt; s := (!s).Push(n) )    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; !s    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; member x.Count =     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; let rec count t (cur:ImmutableStack) =    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; match cur.IsEmpty with     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | true -&gt; t    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | false -&gt; count (t+1) (cur.Pop())    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; count 0 x    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; member x.IsEmpty =     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; match x with    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | EmptyStack -&gt; true    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | _ -&gt; false    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; member x.Push(y) = Value(y,x)    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; member x.Peek() =    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; match x with    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | EmptyStack -&gt; failwith &quot;ImmutableStack is empty&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | Value (v,_) -&gt; v    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; member x.Pop() =    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; match x with     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | EmptyStack -&gt; failwith &quot;ImmutableStack is empty&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | Value (_,n) -&gt; n    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; member x.Reverse() =    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; let rec doBuild (cur:ImmutableStack) (building:ImmutableStack) =    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; match cur.IsEmpty with    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | true -&gt; building    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | false -&gt; doBuild (cur.Pop()) (building.Push(cur.Peek()))    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; doBuild x ImmutableStack.Empty    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; member x.All() =    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; match x with     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | EmptyStack-&gt; Seq.empty&lt;int&gt;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | Value (v,n) -&gt; seq {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield v    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield! n.All() }</p></div>
    
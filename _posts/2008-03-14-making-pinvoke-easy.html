<p>I very excited to announce we recently released a tool I've been working on to MSDN that will greatly help with using PInvoke in managed code.&nbsp; The tool is called the "PInvoke Interop Assistant" and is included as part of a MSDN article on marshalling data for PInvoke and Reverse PInvoke scenarios.&nbsp; </p> <p>Here is a link to the article and tool</p> <ul> <li>Article: <a title="http://msdn2.microsoft.com/en-us/magazine/cc164193.aspx" href="http://msdn2.microsoft.com/en-us/magazine/cc164193.aspx">http://msdn2.microsoft.com/en-us/magazine/cc164193.aspx</a>  <li>Tool: <a title="CLRInsideOut2008_01.exe" href="http://download.microsoft.com/download/f/2/7/f279e71e-efb0-4155-873d-5554a0608523/CLRInsideOut2008_01.exe">CLRInsideOut2008_01.exe</a></li></ul> <p>The motivation behind this tool is writing PInvoke is a hard and often tedious task. There are many rules you must obey and many exceptions that must be taken into account.&nbsp; Anything beyond simple data structures gets very involved and subtle semantics of C can greatly change the needed signature.&nbsp; Incorrect translations often result in obscure exceptions or crashes.</p> <p>In short, it's not any fun. </p> <p>The tool works in several different ways to make PInvoke generation an easier process.&nbsp; The goal is to make generating managed code for structs, unions, enums, constants, functions, typedefs , etc ... as easy as possible. The resulting code can be generated in both VB and C#. </p> <p>The GUI version of the tool operates in 3 modes.&nbsp;&nbsp; </p> <ol> <li>SigImp Search: Search for a commonly used function and translate it into managed code.  <li>SigImp Translate Snippet: Directly translate C code into managed PInvoke signatures.  <li>SigExp: Convert managed binaries into C++ Reverse PInvoke scenarios</li></ol> <p>The first two are the parts I worked on and represent the PInvoke scenarios.&nbsp; The third part was written by Ladi Prosek and will be covered in a different article. We chose the names SigImp and SigExp to mirror the tblimp/tlbexp tool base since they have similar functions.</p> <h3>Directly translating C code into PInvoke Signatures</h3> <p>Most adventures in PInvoke start with a developer having a small set of C code they would like to use from a managed binary.&nbsp; Typically it's one or two functions with several supporting C structs.&nbsp; Before, all of this would be hand translated into managed code from scratch.&nbsp; With this tool all you must do is paste the code into the tool and it will generate the interop signature for you.&nbsp; </p> <p>For instance assume you wanted to translate the following C code into VB.&nbsp; </p><pre class="code"><span style="color: rgb(0,0,255)">struct</span> S1
{
  <span style="color: rgb(0,0,255)">int</span> a;
  <span style="color: rgb(0,0,255)">char</span>[10] b;
};

<span style="color: rgb(0,0,255)">float</span> CalculateData(S1* p);</pre><a href="http://11011.net/software/vspaste"></a>
<p>Start up the tool and switch to the "SigImp Translate Snippet" tab.&nbsp; Then paste the code in and then hit the Generate button.&nbsp; </p>
<p><a href="http://blogs.msdn.com/blogfiles/jaredpar/WindowsLiveWriter/MakingPInvokeEasy_E069/PInvoke1_4.png" target="_blank"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="157" alt="PInvoke1" src="http://blogs.msdn.com/blogfiles/jaredpar/WindowsLiveWriter/MakingPInvokeEasy_E069/PInvoke1_thumb_1.png" width="244" border="0"></a>&nbsp;</p>
<p>You can also set click the "Auto Generate" box and watch the code update as you type.&nbsp; </p>
<p>This translation is not limited to built-in C types.&nbsp; It will also resolve most commonly used windows types such as HANDLE, DWORD all the way up to complex structs such as <a href="http://msdn2.microsoft.com/en-us/library/aa365740(VS.85).aspx">WIN32_FIND_DATA</a></p>
<h3>Searching for a commonly used function</h3>
<p>Often developers want to use C functions familiar to them in managed code.&nbsp; This can be a tedious task as well because if the signature is not already available you are back to coding from scratch.&nbsp; Even adding a constant value can be tricky if you don't know which header file to look in.&nbsp; </p>
<p>The tool also provides a database of many commonly used functions, structs, constants, etc ... It is essentially anything that is included from windows.h.&nbsp; Switch to the SigImp search tab, type the name of what you are looking for and hit generate.&nbsp; For example if I want to see the value for WM_PAINT just type it in.&nbsp; </p>
<p><a href="http://blogs.msdn.com/blogfiles/jaredpar/WindowsLiveWriter/MakingPInvokeEasy_E069/Pinvoke2_2.png" target="_blank"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="157" alt="Pinvoke2" src="http://blogs.msdn.com/blogfiles/jaredpar/WindowsLiveWriter/MakingPInvokeEasy_E069/Pinvoke2_thumb.png" width="244" border="0"></a> </p>
<p>In addition this part of the tool will also do dependency calculation.&nbsp; For instance if choose a method which has a parameter that is a C structure it will automatically generate the structure with the function.&nbsp; For instance if you choose the function <a href="http://msdn2.microsoft.com/en-us/library/aa364418.aspx">FindFirstFile</a> it will determine that the function depends on the WIN32_FIND_DATA structure.&nbsp; Furthermore it will notice that WIN32_FIND_DATA depends on FILETIME and generate both in addition to the method.</p><pre class="code">&lt;System.Runtime.InteropServices.StructLayoutAttribute( _
    System.Runtime.InteropServices.LayoutKind.Sequential, _
    CharSet:=System.Runtime.InteropServices.CharSet.[Unicode])&gt; _
<span style="color: rgb(0,0,255)">Public</span> <span style="color: rgb(0,0,255)">Structure</span> WIN32_FIND_DATAW
    <span style="color: rgb(0,128,0)">'''DWORD-&gt;unsigned int
</span>    <span style="color: rgb(0,0,255)">Public</span> dwFileAttributes <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">UInteger
</span>    <span style="color: rgb(0,128,0)">'''FILETIME-&gt;_FILETIME
</span>    <span style="color: rgb(0,0,255)">Public</span> ftCreationTime <span style="color: rgb(0,0,255)">As</span> FILETIME
    <span style="color: rgb(0,128,0)">'''FILETIME-&gt;_FILETIME
</span>    <span style="color: rgb(0,0,255)">Public</span> ftLastAccessTime <span style="color: rgb(0,0,255)">As</span> FILETIME
    <span style="color: rgb(0,128,0)">'''FILETIME-&gt;_FILETIME
</span>    <span style="color: rgb(0,0,255)">Public</span> ftLastWriteTime <span style="color: rgb(0,0,255)">As</span> FILETIME
    <span style="color: rgb(0,128,0)">'''DWORD-&gt;unsigned int
</span>    <span style="color: rgb(0,0,255)">Public</span> nFileSizeHigh <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">UInteger
</span>    <span style="color: rgb(0,128,0)">'''DWORD-&gt;unsigned int
</span>    <span style="color: rgb(0,0,255)">Public</span> nFileSizeLow <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">UInteger
</span>    <span style="color: rgb(0,128,0)">'''DWORD-&gt;unsigned int
</span>    <span style="color: rgb(0,0,255)">Public</span> dwReserved0 <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">UInteger
</span>    <span style="color: rgb(0,128,0)">'''DWORD-&gt;unsigned int
</span>    <span style="color: rgb(0,0,255)">Public</span> dwReserved1 <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">UInteger
</span>    <span style="color: rgb(0,128,0)">'''WCHAR[260]
</span>    &lt;System.Runtime.InteropServices.MarshalAsAttribute( _
        System.Runtime.InteropServices.UnmanagedType.ByValTStr, SizeConst:=260)&gt; _
    <span style="color: rgb(0,0,255)">Public</span> cFileName <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">String
</span>    <span style="color: rgb(0,128,0)">'''WCHAR[14]
</span>    &lt;System.Runtime.InteropServices.MarshalAsAttribute( _
        System.Runtime.InteropServices.UnmanagedType.ByValTStr, SizeConst:=14)&gt; _
    <span style="color: rgb(0,0,255)">Public</span> cAlternateFileName <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">String
End</span> <span style="color: rgb(0,0,255)">Structure

</span>&lt;System.Runtime.InteropServices.StructLayoutAttribute( _
    System.Runtime.InteropServices.LayoutKind.Sequential)&gt; _
<span style="color: rgb(0,0,255)">Public</span> <span style="color: rgb(0,0,255)">Structure</span> FILETIME
    <span style="color: rgb(0,128,0)">'''DWORD-&gt;unsigned int
</span>    <span style="color: rgb(0,0,255)">Public</span> dwLowDateTime <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">UInteger
</span>    <span style="color: rgb(0,128,0)">'''DWORD-&gt;unsigned int
</span>    <span style="color: rgb(0,0,255)">Public</span> dwHighDateTime <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">UInteger
End</span> <span style="color: rgb(0,0,255)">Structure

Partial</span> <span style="color: rgb(0,0,255)">Public</span> <span style="color: rgb(0,0,255)">Class</span> NativeMethods
    <span style="color: rgb(0,128,0)">'''Return Type: HANDLE-&gt;void*
</span>    <span style="color: rgb(0,128,0)">'''lpFileName: LPCWSTR-&gt;WCHAR*
</span>    <span style="color: rgb(0,128,0)">'''lpFindFileData: LPWIN32_FIND_DATAW-&gt;_WIN32_FIND_DATAW*
</span>    &lt;System.Runtime.InteropServices.DllImportAttribute(<span style="color: rgb(163,21,21)">"kernel32.dll"</span>, EntryPoint:=<span style="color: rgb(163,21,21)">"FindFirstFileW"</span>)&gt; _
    <span style="color: rgb(0,0,255)">Public</span> <span style="color: rgb(0,0,255)">Shared</span> <span style="color: rgb(0,0,255)">Function</span> FindFirstFileW( _
        &lt;System.Runtime.InteropServices.InAttribute(), _
            System.Runtime.InteropServices.MarshalAsAttribute(System.Runtime.InteropServices.UnmanagedType.LPWStr)&gt; _
            <span style="color: rgb(0,0,255)">ByVal</span> lpFileName <span style="color: rgb(0,0,255)">As</span> <span style="color: rgb(0,0,255)">String</span>, _
        &lt;System.Runtime.InteropServices.OutAttribute()&gt; _
        <span style="color: rgb(0,0,255)">ByRef</span> lpFindFileData <span style="color: rgb(0,0,255)">As</span> WIN32_FIND_DATAW) <span style="color: rgb(0,0,255)">As</span> System.IntPtr
    <span style="color: rgb(0,0,255)">End</span> <span style="color: rgb(0,0,255)">Function
End</span> <span style="color: rgb(0,0,255)">Class</span></pre><a href="http://11011.net/software/vspaste"></a>
<h3>Translating Large Code bases</h3>
<p>The snippet translator works well for small snippets of code.&nbsp; If you are trying to translate a much larger code base, say several interdependent header files the small snippet dialog won't work well.&nbsp; To work with larger code bases you should use the command line version of the tool;&nbsp; sigimp.exe.&nbsp; It is designed to process several header files and produce a mass output.&nbsp; </p>
<h3>Wrapping Up</h3>
<p>This tool started out as a pet project of mine some time ago.&nbsp; I'm extremely excited that customers are now going to be able to take advantage of it and I greatly look forward to any feedback you have.&nbsp; I will post a couple more articles in the future detailing how this tool works under the hood.&nbsp; </p></div>
    